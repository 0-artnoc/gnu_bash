*** /fs1/chet/scratch/bash-4.0-patched/parse.y	2009-03-07 15:18:35.000000000 -0500
--- parse.y	2009-03-07 14:16:32.000000000 -0500
***************
*** 3404,3423 ****
  {
  		tflags |= LEX_INCASE;
! /*itrace("parse_comsub:%d: found `case', lex_incase -> 1", line_number);*/
  }
  	      else if (STREQN (ret + retind - 4, "esac", 4))
  {
  		tflags &= ~LEX_INCASE;
! /*itrace("parse_comsub:%d: found `esac', lex_incase -> 0", line_number);*/
  }	        
  	      tflags &= ~LEX_RESWDOK;
  	    }
! 	  else if (shellbreak (ch) == 0)
  {
! 	      tflags &= ~LEX_RESWDOK;
  /*itrace("parse_comsub:%d: found `%c', lex_reswordok -> 0", line_number, ch);*/
  }
  	}
  
        if MBTEST((tflags & LEX_INCOMMENT) == 0 && (tflags & LEX_CKCASE) && ch == '<')
  	{
--- 3407,3439 ----
  {
  		tflags |= LEX_INCASE;
! /*itrace("parse_comsub:%d: found `case', lex_incase -> 1 lex_reswdok -> 0", line_number);*/
  }
  	      else if (STREQN (ret + retind - 4, "esac", 4))
  {
  		tflags &= ~LEX_INCASE;
! /*itrace("parse_comsub:%d: found `esac', lex_incase -> 0 lex_reswdok -> 0", line_number);*/
  }	        
  	      tflags &= ~LEX_RESWDOK;
  	    }
! 	  else if MBTEST((tflags & LEX_CKCOMMENT) && ch == '#' && (lex_rwlen == 0 || ((tflags & LEX_INWORD) && lex_wlen == 0)))
! 	    ;	/* don't modify LEX_RESWDOK if we're starting a comment */
! 	  else if MBTEST((tflags & LEX_INCASE) && ch != '\n')
! 	    /* If we can read a reserved word and we're in case, we're at the
! 	       point where we can read a new pattern list or an esac.  We
! 	       handle the esac case above.  If we read a newline, we want to
! 	       leave LEX_RESWDOK alone.  If we read anything else, we want to
! 	       turn off LEX_RESWDOK, since we're going to read a pattern list. */
  {
! 	    tflags &= ~LEX_RESWDOK;
! /*itrace("parse_comsub:%d: lex_incase == 1 found `%c', lex_reswordok -> 0", line_number, ch);*/
! }
! 	  else if MBTEST(shellbreak (ch) == 0)
! {
! 	    tflags &= ~LEX_RESWDOK;
  /*itrace("parse_comsub:%d: found `%c', lex_reswordok -> 0", line_number, ch);*/
  }
  	}
  
+       /* Might be the start of a here-doc delimiter */
        if MBTEST((tflags & LEX_INCOMMENT) == 0 && (tflags & LEX_CKCASE) && ch == '<')
  	{
